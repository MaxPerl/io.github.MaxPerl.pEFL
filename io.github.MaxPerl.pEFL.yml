app-id: io.github.MaxPerl.pEFL
runtime: org.gnome.Platform
runtime-version: '43'
sdk: org.gnome.Sdk
modules:
  - "shared_modules/luajit.json"
  - name: mtdev
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/rydberg/mtdev.git
  - name: libinput
    buildsystem: meson
    config-opts:
      - "-Dlibwacom=false"
      - "-Dtests=false"
    sources:
      - type: archive
        url: https://gitlab.freedesktop.org/libinput/libinput/-/archive/1.23.0/libinput-1.23.0.tar.gz
        sha256: 7a7c90fbc59f1f65c781a51fa634e4f79e460bf6e16ad68afbe7965d25d09738
  - name: poppler
    buildsystem: cmake
    config-opts:
      - "-DENABLE_BOOST=OFF"
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-23.08.0.tar.xz
        sha256: 4a4bf7fc903b9f1a2ab7d04b7c5d8220db9bc6261cc73fdb9a826dc272f49aa8
  - name: gs
    buildsystem: simple
    build-commands:
      - ./configure --prefix=${FLATPAK_DEST}
      - make soinstall
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs10012/ghostscript-10.01.2.tar.gz
        sha256: a4cd61a07fec161bee35da0211a5e5cde8ff8a0aaf942fc0176715e499d21661
  - name: libspectre
    buildsystem: autotools
    sources:
      - type: archive
        url: http://libspectre.freedesktop.org/releases/libspectre-0.2.12.tar.gz
        sha256: 55a7517cd3572bd2565df0cf450944a04d5273b279ebb369a895391957f0f960
  - name: efl
    buildsystem: meson
    config-opts:
      - "-Decore-imf-loaders-disabler=['ibus','scim']"
      - "-Devas-loaders-disabler=['json', 'avif', 'heif','raw']"
      - "-Dbuild-tests=false"
    sources:
      - type: archive
        url: https://download.enlightenment.org/rel/libs/efl/efl-1.26.3.tar.xz
        sha256: d9f83aa0fd9334f44deeb4e4952dc0e5144683afac786feebce6030951617d15
      - type: patch
        path: p1.patch
  # Installs Perl.
  # (Based on: https://github.com/flathub/io.github.Hexchat.Plugin.Perl)
  - name: perl
    no-autogen: true
    config-opts:
      - '-des'
      # Build a shared library.
      - '-Duseshrplib'
      - '-Dusethreads'
    build-options:
      cflags: '-fPIC'
      ldflags: '-fpic'
    sources:
      - type: archive
        url: https://www.cpan.org/src/5.0/perl-5.32.1.tar.gz
        sha256: 03b693901cd8ae807231b1787798cf1f2e0b8a56218d07b7da44f784a7caeb2c
      - type: script
        dest-filename: 'configure'
        commands:
          - 'exec ./configure.gnu $@'
    # Restore write permission to the Perl libraries.
    post-install:
      - 'chmod -R u+w /app/lib/perl5'
    # Clean up a bunch of stuff we don't need. Depending on your application,
    # you may have to drop some of these (e.g. *.pod).
    cleanup:
      - '/bin/corelist'
      - '/bin/cpan'
      - '/bin/enc2xs'
      - '/bin/encguess'
      - '/bin/h2ph'
      - '/bin/h2xs'
      - '/bin/instmodsh'
      - '/bin/json_pp'
      - '/bin/libnetcfg'
      - '/bin/perlbug'
      - '/bin/perldoc'
      - '/bin/perlivp'
      - '/bin/perlthanks'
      - '/bin/piconv'
      - '/bin/pl2pm'
      - '/bin/pod*'
      - '/bin/prove'
      - '/bin/ptar*'
      - '/bin/shasum'
      - '/bin/splain'
      - '/bin/xsubpp'
      - '/bin/zipdetails'
      - '/man'
      - '*.pod'
  # Installs the modules generated by flatpak-cpan-generator.
  # Note that *any* Makefile.PL-style modules MUST be installed in this one step,
  # as once perllocal.pod is written in one module, it cannot be modified by others.
  - name: perl-libs
    buildsystem: simple
    build-commands:
      - 'perl-libs/install.sh'
    # Same as with the Perl module, we need to restore write permission.
    # However, -f is now passed to avoid errors from trying to touch files from the
    # above module that are now marked as read-only.
    post-install:
      - 'chmod -Rf u+w /app/lib/perl5/site_perl'
    sources:
      - generated-sources.json
    # This step should be customized based on the CPAN packages you're using.
    cleanup:
      - '/bin'
      - '/man'
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Wayland access
  - --socket=wayland
  # Needs to talk to the network:
  - --share=network
  # Needs to save files locally
  - --filesystem=xdg-documents
  - --metadata=X-DConf=migrate-path=/org/gnome/dictionary/
cleanup:
  - '/include'
  - '*.a' 
  - '/share/doc'
  - '/share/man'